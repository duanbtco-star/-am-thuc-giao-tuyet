# Database Rules - Ẩm Thực Giáo Tuyết

> **Load when**: Database schema, migrations, SQL queries.
> **Stack**: Supabase (PostgreSQL), Single-tenant

---

## 1. RLS Configuration (Single-Tenant)

> ⚠️ **Single-tenant**: Không cần `tenant_id`, nhưng vẫn bật RLS.

### 1.1 Standard Table Template
```sql
CREATE TABLE {table_name} (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    -- columns here
    created_at TIMESTAMPTZ DEFAULT NOW(),
    updated_at TIMESTAMPTZ DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE {table_name} ENABLE ROW LEVEL SECURITY;

-- Simple policies for single-tenant
CREATE POLICY "Enable read for all" ON {table_name}
    FOR SELECT USING (true);

CREATE POLICY "Enable insert for auth" ON {table_name}
    FOR INSERT WITH CHECK (true);

CREATE POLICY "Enable update for auth" ON {table_name}
    FOR UPDATE USING (true);

CREATE POLICY "Enable delete for auth" ON {table_name}
    FOR DELETE USING (true);

-- Auto-update timestamp trigger
CREATE TRIGGER set_{table_name}_updated_at
    BEFORE UPDATE ON {table_name}
    FOR EACH ROW
    EXECUTE FUNCTION update_updated_at_column();
```

### 1.2 Checklist mỗi table
- [ ] `id UUID PRIMARY KEY DEFAULT gen_random_uuid()`
- [ ] `created_at TIMESTAMPTZ DEFAULT NOW()`
- [ ] `updated_at TIMESTAMPTZ DEFAULT NOW()`
- [ ] `ENABLE ROW LEVEL SECURITY`
- [ ] Policies cho SELECT, INSERT, UPDATE, DELETE
- [ ] Trigger cập nhật `updated_at`

---

## 2. Existing Tables

| Table | Purpose | Key Columns |
|:---|:---|:---|
| `menus` | Thực đơn | `name`, `selling_price`, `category` |
| `quotes` | Báo giá | `quote_number`, `customer_name`, `dishes` |
| `orders` | Đơn hàng | `order_number`, `event_date`, `status` |
| `calendar_events` | Lịch | `event_date`, `order_id` |
| `vendors` | Nhà cung cấp | `name`, `category`, `phone` |
| `transactions` | Thu chi | `type`, `amount`, `date` |
| `settings` | Cài đặt | `key`, `value` |

---

## 3. JSONB Usage

### 3.1 Storing Dishes in Quotes
```sql
-- Format
dishes JSONB DEFAULT '[]'

-- Example data
[
  {"name": "Gà hấp lá chanh", "price": 180000, "quantity": 10},
  {"name": "Canh chua cá lóc", "price": 120000, "quantity": 5}
]
```

### 3.2 Querying JSONB
```sql
-- Get total dishes count
SELECT jsonb_array_length(dishes) FROM quotes;

-- Extract dish names
SELECT dish->>'name' as dish_name
FROM quotes, jsonb_array_elements(dishes) AS dish;
```

---

## 4. Auto-Generated Numbers

### 4.1 Quote Number Format
```
BGAM001-DDMMYYYY
```

### 4.2 Order Number Format
```
ORD001-DDMMYYYY
```

**Generated by**: PostgreSQL trigger functions

---

## 5. Migration Strategy

### 5.1 File Location
```
supabase/migrations/{timestamp}_{description}.sql
```

### 5.2 Migration Template
```sql
-- supabase/migrations/002_add_feature.sql
BEGIN;

-- Add new column
ALTER TABLE {table} ADD COLUMN new_col TYPE;

-- Create new table
CREATE TABLE new_table (...);
ALTER TABLE new_table ENABLE ROW LEVEL SECURITY;
-- policies...

COMMIT;
```

---

## 6. Naming Conventions

| Element | Convention | Example |
|:---|:---|:---|
| Table | `snake_case`, plural | `calendar_events` |
| Column | `snake_case` | `event_date` |
| Primary Key | `id` | `id UUID` |
| Foreign Key | `{table}_id` | `order_id` |
| Index | `idx_{table}_{column}` | `idx_orders_status` |

---

## 7. Common Queries

### 7.1 Get Today's Orders
```sql
SELECT * FROM orders 
WHERE event_date = CURRENT_DATE 
ORDER BY created_at DESC;
```

### 7.2 Monthly Revenue Report
```sql
SELECT 
    DATE_TRUNC('month', date) as month,
    SUM(CASE WHEN type = 'income' THEN amount ELSE 0 END) as income,
    SUM(CASE WHEN type = 'expense' THEN amount ELSE 0 END) as expense
FROM transactions
WHERE date >= DATE_TRUNC('year', CURRENT_DATE)
GROUP BY 1
ORDER BY 1;
```
